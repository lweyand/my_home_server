---

- name: Samba| Install samba
  apt:
    name: "{{ samba_packages | join(',') }}"
    state: present

- name: Samba| Create samba users
  shell: "printf '{{ server_passwords | dict2items | json_query(select_query) | json_query(get_query) | first }}\n{{ server_passwords | dict2items | json_query(select_query) | json_query(get_query) | first }}\n' | smbpasswd -s -a {{ item.value.user }}"
  register: smbpasswd
  changed_when: "'Added user' in smbpasswd.stdout"
  when: "'samba' in item.value.services"
  loop: "{{ lookup('dict', spaces) }}"
  vars:
    select_query: "[?key=='{{ item.value.user }}']"
    get_query: "[*].value.password"
  notify:
    - restart samba

- name: Samba| Configure global samba
  template:
    src: templates/samba/global.conf
    dest: /etc/samba/smb.conf
    owner: root
    group: root
    mode: 0644
    validate: 'testparm -s %s'
  notify:
    - restart samba

- name: Samba| Configure samba spaces
  blockinfile:
    dest: /etc/samba/smb.conf
    block: "{{ lookup('template', 'templates/samba/directory.conf') }}"
    marker: "; {mark} ANSIBLE MANAGED BLOCK FOR {{ item.key }}"
    validate: 'testparm -s %s'
  when: "'samba' in item.value.services"
  loop: "{{ lookup('dict', spaces) }}"
  notify:
    - restart samba
