
{% if item.value.server_name is defined %}
<VirtualHost _default_>
    ServerName {{ item.value.server_name }}
{%      if item.value.server_alias is defined %}
    ServerAlias {{ item.value.server_alias }}
{%      endif %}
    DocumentRoot /home/srv/{{ item.key }}/www
    ScriptAlias /cgi-bin /home/srv/{{ item.key }}/cgi-bin
    Alias       /files   /home/srv/{{ item.key }}/files
</VirtualHost>
{% endif %}

#------------------------------------------------------------
# {{ item.key }} ibay directories ({{ item.value.comment }})
#------------------------------------------------------------

<Directory /home/srv/{{ item.key }}/www>
    Options None
    Options +Indexes
    {% if 'enable' == item.value.exec_dynamic %}
    Options +Includes
    {% else %}
    DirectoryIndex index.shtml index.htm index.html
    Options +IncludesNOEXEC
    <FilesMatch "\.(php|phtml)$">
        Require all denied
    </FilesMatch>
    {% endif %}
    AllowOverride None

    # https://httpd.apache.org/docs/2.4/fr/upgrading.html
    {% if item.value.web_access in [ 'all_internet_with_password', 'all_internet_with_password_except_local', 'lan_with_password' ] %}
    AuthName "{{ item.value.comment }}"
    AuthType Basic
    AuthBasicProvider external
    AuthExternal pwauth
    {%      if 'all_internet_with_password' == item.value.web_access %}
    <RequireAll>
        Require user {{ item.value.user }}
    </RequireAll>
    {%      elif 'all_internet_with_password_except_local' == item.value.web_access %}
    <RequireAny>
        Require user {{ item.value.user }}
        Require ip {{ inventory_hostname }}/255.255.255.0
    </RequireAny>
    {%      elif 'lan_with_password' == item.value.web_access %}
    <RequireAll>
        Require user {{ item.value.user }}
        Require ip {{ inventory_hostname }}/255.255.255.0
    </RequireAll>
    {%      endif %}
    {% elif 'lan_no_password' == item.value.web_access %}
    Require ip {{ inventory_hostname }}/255.255.255.0
    {% else %}
    Require all granted
    {%- endif %}

</Directory>

<Directory /home/srv/{{ item.key }}/cgi-bin>
    {% if 'enable' == item.value.exec_dynamic %}
    Options ExecCGI
    {% endif %}
    AllowOverride None
    {% if item.value.web_access in [ 'all_internet_with_password', 'all_internet_with_password_except_local', 'lan_with_password' ] %}
    AuthName "{{ item.value.comment }}"
    AuthType Basic
    AuthBasicProvider external
    AuthExternal pwauth
    {%      if 'all_internet_with_password' == item.value.web_access %}
    <RequireAll>
        Require user {{ item.value.user }}
    </RequireAll>
    {%      elif 'all_internet_with_password_except_local' == item.value.web_access %}
    <RequireAny>
        Require user {{ item.value.user }}
        Require ip {{ inventory_hostname }}/255.255.255.0
    </RequireAny>
    {%      elif 'lan_with_password' == item.value.web_access %}
    <RequireAll>
        Require user {{ item.value.user }}
        Require ip {{ inventory_hostname }}/255.255.255.0
    </RequireAll>
    {%      endif %}
    {% elif 'lan_no_password' == item.value.web_access %}
    Require ip {{ inventory_hostname }}/255.255.255.0
    {% else %}
    Require all granted
    {%- endif %}

</Directory>

<Directory /home/srv/{{ item.key }}/files>
    AllowOverride None
    {% if item.value.web_access in [ 'all_internet_with_password', 'all_internet_with_password_except_local', 'lan_with_password' ] %}
    AuthName "{{ item.value.comment }}"
    AuthType Basic
    # TODO http://icephoenix.us/linuxunix/apache-and-http-authentication-with-pam/
    AuthBasicProvider external
    AuthExternal pwauth
    {%      if 'all_internet_with_password' == item.value.web_access %}
    <RequireAll>
        Require user {{ item.value.user }}
    </RequireAll>
    {%      elif 'all_internet_with_password_except_local' == item.value.web_access %}
    <RequireAny>
        Require user {{ item.value.user }}
        Require ip {{ inventory_hostname }}/255.255.255.0
    </RequireAny>
    {%      elif 'lan_with_password' == item.value.web_access %}
    <RequireAll>
        Require user {{ item.value.user }}
        Require ip {{ inventory_hostname }}/255.255.255.0
    </RequireAll>
    {%      endif %}
    {% elif 'lan_no_password' == item.value.web_access %}
    Require ip {{ inventory_hostname }}/255.255.255.0
    {% else %}
    Require all granted
    {%- endif %}

</Directory>

{% if 'enable' == item.value.exec_dynamic %}
<Directory /home/e-smith/files/ibays/tests/html>
    AddType application/x-httpd-php .php .phtml
    AddType application/x-httpd-php-source .phps
    php_admin_value open_basedir /home/e-smith/files/ibays/tests/
</Directory>
{% endif %}